import t from"fs-extra";import e from"get-value";import r from"object.defaults/mutable.js";import o from"ora";import a from"chalk";import n from"log-symbols";import s from"path";import i from"sane";import{debounce as c}from"throttle-debounce";import l from"camelcase";import p from"find-up";import u from"globby";import f from"uppercamelcase";import d from"set-value";import m from"pupa";import{promisify as g}from"util";import{exec as h}from"child_process";function y(t){return t.replace(/([\da-z])([A-Z])/g,"$1-$2").replace(/([A-Z])([A-Z])(?=[a-z])/g,"$1-$2").toLowerCase()}function w(t,e){const r=/@([\d.]+)x/.exec(t);return r?Number.parseFloat(r[1]):void 0!==e?e:1}function $(t){let r=e(t,"meta.number_of_packs",{default:0});return 0===r&&(r=e(t,"meta.related_multi_packs",{default:[]}).length+1),r}function j(t,e){let r=(t=`${t}`).replace(`${e}/`,"").split("/").map((t=>function(t){return t.replace(/(\W)/g,"_").replace(/_{2,}/g,".").replace(/^_/,"").replace(/_$/,"")}(t))),o=r.pop();o=o.toUpperCase(),r=r.map((t=>l(t)));let a=e.split("/");return a=a.slice(a.length-(1===a.length?1:2)),a.push("sprites"),a=f(a.join("-")),r.length>0?[a,t=(t=r.join(".")).replace(/(\W^\.)/g,"").replace(/\.{2,}/g,".").replace(/^\./,"").replace(/\.$/,""),o].join("."):[a,o].join(".")}function b(t){if(t.length>0){const r=t[0];return e(r,"meta.number_of_packs",{default:1})}return 0}async function x(r,o,a,n){const i=await async function(r,o,a,n){const i=e(n,"includeSizeInfo",a.includeSizeInfo),c=e(n,"includePNGExpressMetadata",a.includePNGExpressMetadata),l={};if(!i&&!c)return l;if(c)try{const e=await p("pngexpress-metadata.json",{cwd:s.join(a.sourceDirectory,o),type:"file"});if(e){const r=`${s.relative(e,s.join(a.sourceDirectory,o)).replace("../","")}/`,n=await t.readJson(e);for(const t of n.assets)for(const e of t.states){let a=o+t.id.replace(r,"");a="/"===a[0]?a.slice(1):a,a="default"===e?a:a+e;const n={...t};delete n.id,delete n.states,l[a]=n}return l}}catch(t){console.log(t)}for(const t of r||[])for(const e of Object.keys(t.frames)){const r=t.frames[e];l[e]={id:e,width:r.sourceSize.w,height:r.sourceSize.h}}return l}(r,o,a,n),c=o,l={};for(const t of r||[])for(const e of Object.keys(t.frames)){let t=e;i[e]&&(t={id:e,...i[e]}),d(l,j(e,c),t)}return l}function k(t,e){let r="";const o=Object.keys(t)[0],a=function(t){const e=[];for(const r of Object.keys(t))Object.prototype.hasOwnProperty.call(t,r)&&e.push([r,t[r]]);e.sort(((t,e)=>{const r=t[0],o=e[0];return r<o?-1:r>o?1:0}));const r={};for(const t of e)r[t[0]]=t[1];return r}(t[o]);let n=JSON.stringify(a,void 0,2);return n=n.replace(/"([^"()]+)":/g,"$1:"),r=`${r}${m("export const {assetName} = {assetData};",{assetName:o,assetData:n})}\n`,r=`${r}${m("export const {assetsVariable}LoaderInfo = {\n  assets: {assetsVariable},\n  fileName : '{fileName}',\n  numberOfParts : {numberOfParts},\n  type: 'sprites'\n};",{assetsVariable:o,fileName:e.fileName,numberOfParts:e.numberOfParts})}\n`,r}async function v(r,o,a){const n=e(a,"scriptDirectory",o.scriptDirectory),i=await u(`${s.join(o.targetDirectory,r)}/*[0-9]+.json`),c=[];for(const e of i)c.push(t.readJson(e));const l=await Promise.all(c),p=k(await x(l,r,o,a),{fileName:r,numberOfParts:b(l)}),f=function(t,e){const r=t.split("/"),o=r.pop();return r.length<2&&r.push(o),t=r.join("/"),`${s.join(e,t)}/assets/sprites-${o}.ts`}(r,n);await t.outputFile(f,p)}const D=g(h),O={format:"pixijs4","texture-format":"png","jpg-quality":100,"png-opt-level":0,opt:"RGBA8888","prepend-folder-name":!0,"trim-sprite-names":!0,algorithm:"MaxRects","maxrects-heuristics":"Best","pack-mode":"Best","scale-mode":"Smooth",multipack:!0,"force-identical-layout":!0,"trim-mode":"Trim","alpha-handling":"ClearTransparentPixels","default-pivot-point":"0,0","enable-rotation":!0,quiet:!0,extrude:"0","shape-padding":"2",variant:["1:@2x","0.5:"]};async function P(t,e){const o=function(t,e){"1"===(e=e||{}).extrude&&(e["shape-padding"]=0);const r=new _;r.addPath(`${t}`);for(const t of Object.keys(e))r.addOption(t,e[t]);return r.build()}(t,r(e,O));try{await D(o)}catch(t){if(t&&t.stderr)throw new Error(t.stderr);return!1}return!0}class _{constructor(){this.commands=[],this.path=""}addPath(t){this.path=t}addOption(t,e){this.commands.push({option:`--${y(t)}`,value:e})}build(){if(!this.path)throw new Error("Must specify a path to process (image/directory)");const t=this.commands.map((t=>this.resolveValue(t.option,t.value))).join(" ");return`TexturePacker ${this.path} ${t}`}resolveValue(t,e){return Array.isArray(e)?e.map((e=>this.resolveValue(t,e))).join(" "):`${t}${e=!0===e?"":` ${e}`}`}}const N={},A={};async function S(r,i){let c,l;Array.isArray(r)?(c=r[0],l=r[1]):c=r;const p=c.split("/").pop();if(N[c])return console.log(n.warning,a.yellow("Allready packing, starting again afterwards...")),void(A[c]=!0);N[c]=!0;const f=e(l,"textureFormat",i.textureFormat),m={sheet:`${s.join(i.targetDirectory,c,p)}-{n1}{v}.${f}`,data:`${s.join(i.targetDirectory,c,p)}-{n1}{v}.json`,replace:`^${p}=${c}`,extrude:e(l,"extrude",i.extrude)?"1":"0","texture-format":f},g=o(`Packing ${c}`).start();try{if(!await P(`${s.join(i.sourceDirectory,c)}`,m))return void g.fail(`Error packing ${c}`)}catch(t){return g.fail(`Error packing ${c}`),void console.error(n.warning,t.message)}await async function(e){const r=await u(`${e}/*.json`);for(const e of r){const r=w(e),o=await t.readJson(e);d(o,"meta.scale",r),d(o,"meta.number_of_packs",$(o)),d(o,"meta.related_multi_packs"),await t.writeJson(e,o)}}(`${s.join(i.targetDirectory,c)}`),await v(c,i,l),N[c]=!1,A[c]?(A[c]=!1,g.warn("Needs repacking, something changed while packing..."),await S(r,i)):g.succeed(`Done packing ${c}`)}async function z(t,e){return new Promise((r=>{let o,l={};if(Array.isArray(t)?(o=t[0],l=t[1]):o=t,!0!==e.watch&&!0!==l.watch||!1===l.watch)return void r();const p=c(e.watchDelay,(()=>{S(t,e)})),u=i(`${s.join(e.sourceDirectory,o)}`,{glob:["**/*.png","**/*.jpg"]});u.on("ready",(()=>{console.log(n.info,a.blue(`Started watching ${o} with a delay of ${e.watchDelay/1e3}s`)),r()})),u.on("change",p),u.on("add",p),u.on("delete",p)}))}async function E(s){const i=await async function(a){const n=o(`Reading settings from ${a}...`).start();let s={};try{const o=await t.readJSON(a);s=e(o,"sprites",{}),s=r(s,{sourceDirectory:"./assets/",scriptDirectory:"./assets/converted/",targetDirectory:"./assets/converted/",watch:!1,watchDelay:500,extrude:!1,textureFormat:"png",includeSizeInfo:!1,includePNGExpressMetadata:!1,directories:[]})}catch{return n.fail(`Could not load settings from ${a}... (does it exist?)`),s}const i=s.directories.length;return i?n.succeed(`Found ${i} directories to process...`):n.fail("Found no directories to process..."),s}(s),c=i.directories;delete i.directories,i&&c&&(await async function(t,e){console.log(n.info,a.blue("Start packing all items..."));for(const r of t)await S(r,e);console.log(n.success,a.green("Done packing all items..."))}(c,i),await async function(t,e){for(const r of t)await z(r,e)}(c,i))}function F(t){E(t||"assets.json")}export{F as pack};

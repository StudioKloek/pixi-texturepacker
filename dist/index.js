import t from"get-value";import e from"ora";import r from"fs-extra";import o from"object.defaults/mutable.js";import{fileURLToPath as a}from"url";import n from"chalk";import s from"log-symbols";import i from"path";import c from"sane";import{debounce as l}from"throttle-debounce";import p from"camelcase";import u from"find-up";import f from"globby";import d from"uppercamelcase";import m from"set-value";import g from"pupa";import{promisify as h}from"util";import{exec as y}from"child_process";function w(t){return t.replace(/([\da-z])([A-Z])/g,"$1-$2").replace(/([A-Z])([A-Z])(?=[a-z])/g,"$1-$2").toLowerCase()}function $(t,e){const r=/@([\d.]+)x/.exec(t);return r?Number.parseFloat(r[1]):void 0!==e?e:1}function j(t,e){let r=(t=`${t}`).replace(`${e}/`,"").split("/").map((t=>function(t){return t.replace(/(\W)/g,"_").replace(/_{2,}/g,".").replace(/^_/,"").replace(/_$/,"")}(t))),o=r.pop();o=o.toUpperCase(),r=r.map((t=>p(t)));let a=e.split("/");return a=a.slice(a.length-(1===a.length?1:2)),a.push("sprites"),a=d(a.join("-")),r.length>0?[a,t=(t=r.join(".")).replace(/(\W^\.)/g,"").replace(/\.{2,}/g,".").replace(/^\./,"").replace(/\.$/,""),o].join("."):[a,o].join(".")}function x(e){if(e.length>0){const r=e[0];return t(r,"meta.related_multi_packs",{default:[]}).length+1}return 0}async function b(e,o,a,n){const s=await async function(e,o,a,n){const s=t(n,"includeSizeInfo",a.includeSizeInfo),c=t(n,"includePNGExpressMetadata",a.includePNGExpressMetadata),l={};if(!s&&!c)return l;if(c)try{const t=await u("pngexpress-metadata.json",{cwd:i.join(a.sourceDirectory,o),type:"file"});if(t){const e=`${i.relative(t,i.join(a.sourceDirectory,o)).replace("../","")}/`,n=await r.readJson(t);for(const t of n.assets)for(const r of t.states){let a=o+t.id.replace(e,"");a="/"===a[0]?a.slice(1):a,a="default"===r?a:a+r;const n={...t};delete n.id,delete n.states,l[a]=n}return l}}catch(t){console.log(t)}for(const t of e||[])for(const e of Object.keys(t.frames)){const r=t.frames[e];l[e]={id:e,width:r.sourceSize.w,height:r.sourceSize.h}}return l}(e,o,a,n),c=o,l={};for(const t of e||[])for(const e of Object.keys(t.frames)){let t=e;s[e]&&(t={id:e,...s[e]}),m(l,j(e,c),t)}return l}function v(t,e){let r="";const o=Object.keys(t)[0],a=function(t){const e=[];for(const r of Object.keys(t))Object.prototype.hasOwnProperty.call(t,r)&&e.push([r,t[r]]);e.sort(((t,e)=>{const r=t[0],o=e[0];return r<o?-1:r>o?1:0}));const r={};for(const t of e)r[t[0]]=t[1];return r}(t[o]);let n=JSON.stringify(a,void 0,2);return n=n.replace(/"([^"()]+)":/g,"$1:"),r=`${r}${g("export const {assetName} = {assetData};",{assetName:o,assetData:n})}\n`,r=`${r}${g("export const {assetsVariable}LoaderInfo {\n  assets: {assetsVariable},\n  fileName : '{fileName}',\n  numberOfParts : {numberOfParts},\n  type: 'sprites'\n};",{assetsVariable:o,fileName:e.fileName,numberOfParts:e.numberOfParts})}\n`,r}async function D(e,o,a){const n=t(a,"scriptDirectory",o.scriptDirectory),s=await f(`${i.join(o.targetDirectory,e)}/*[0-9]+.json`),c=[];for(const t of s)c.push(r.readJson(t));const l=await Promise.all(c),p=v(await b(l,e,o,a),{fileName:e,numberOfParts:x(l)}),u=function(t,e){const r=t.split("/"),o=r.pop();return r.length<2&&r.push(o),t=r.join("/"),`${i.join(e,t)}/assets/sprites-${o}.ts`}(e,n);await r.outputFile(u,p)}const k=h(y),O={format:"pixijs4","texture-format":"png","jpg-quality":100,"png-opt-level":0,opt:"RGBA8888","prepend-folder-name":!0,"trim-sprite-names":!0,algorithm:"MaxRects","maxrects-heuristics":"Best","pack-mode":"Best","scale-mode":"Smooth",multipack:!0,"force-identical-layout":!0,"trim-mode":"Trim","alpha-handling":"ClearTransparentPixels","default-pivot-point":"0,0","enable-rotation":!0,quiet:!0,extrude:"0","shape-padding":"2",variant:["1:@2x","0.5:"]};async function P(t,e){const r=function(t,e){"1"===(e=e||{}).extrude&&(e["shape-padding"]=0);const r=new N;r.addPath(`${t}`);for(const t of Object.keys(e))r.addOption(t,e[t]);return r.build()}(t,o(e,O));try{await k(r)}catch(t){if(t&&t.stderr)throw new Error(t.stderr);return!1}return!0}class N{constructor(){this.commands=[],this.path=""}addPath(t){this.path=t}addOption(t,e){this.commands.push({option:`--${w(t)}`,value:e})}build(){if(!this.path)throw new Error("Must specify a path to process (image/directory)");const t=this.commands.map((t=>this.resolveValue(t.option,t.value))).join(" ");return`TexturePacker ${this.path} ${t}`}resolveValue(t,e){return Array.isArray(e)?e.map((e=>this.resolveValue(t,e))).join(" "):`${t}${e=!0===e?"":` ${e}`}`}}const A={},S={};async function z(o,a){let c,l;Array.isArray(o)?(c=o[0],l=o[1]):c=o;const p=c.split("/").pop();if(A[c])return console.log(s.warning,n.yellow("Allready packing, starting again afterwards...")),void(S[c]=!0);A[c]=!0;const u=t(l,"textureFormat",a.textureFormat),d={sheet:`${i.join(a.targetDirectory,c,p)}-{n1}{v}.${u}`,data:`${i.join(a.targetDirectory,c,p)}-{n1}{v}.json`,replace:`${p}=${c}`,extrude:t(l,"extrude",a.extrude)?"1":"0","texture-format":u},g=e(`Packing ${c}`).start();try{if(!await P(`${i.join(a.sourceDirectory,c)}`,d))return void g.fail(`Error packing ${c}`)}catch(t){return g.fail(`Error packing ${c}`),void console.error(s.warning,t.message)}await async function(t){const e=await f(`${t}/*.json`);for(const t of e){const e=$(t),o=await r.readJson(t);m(o,"meta.scale",e),await r.writeJson(t,o)}}(`${i.join(a.targetDirectory,c)}`),await D(c,a,l),A[c]=!1,S[c]?(S[c]=!1,g.warn("Needs repacking, something changed while packing..."),await z(o,a)):g.succeed(`Done packing ${c}`)}async function E(t,e){return new Promise((r=>{let o,a={};if(Array.isArray(t)?(o=t[0],a=t[1]):o=t,!0!==e.watch&&!0!==a.watch||!1===a.watch)return void r();const p=l(e.watchDelay,(()=>{z(t,e)})),u=c(`${i.join(e.sourceDirectory,o)}`,{glob:["**/*.png","**/*.jpg"]});u.on("ready",(()=>{console.log(s.info,n.blue(`Started watching ${o} with a delay of ${e.watchDelay/1e3}s`)),r()})),u.on("change",p),u.on("add",p),u.on("delete",p)}))}async function F(i){const c=await async function(n){const s=e(`Reading settings from ${n}...`).start();let i={};const c=a(new URL(n,import.meta.url));try{const e=await r.readJSON(c);i=t(e,"sprites",{}),i=o(i,{sourceDirectory:"./assets/",scriptDirectory:"./assets/converted/",targetDirectory:"./assets/converted/",watch:!1,watchDelay:500,extrude:!1,textureFormat:"png",includeSizeInfo:!1,includePNGExpressMetadata:!1,directories:[]})}catch{return s.fail(`Could not load settings from ${n}... (does it exist?)`),i}const l=i.directories.length;return l?s.succeed(`Found ${l} directories to process...`):s.fail("Found no directories to process..."),i}(i),l=c.directories;delete c.directories,c&&l&&(await async function(t,e){console.log(s.info,n.blue("Start packing all items..."));for(const r of t)await z(r,e);console.log(s.success,n.green("Done packing all items..."))}(l,c),await async function(t,e){for(const r of t)await E(r,e)}(l,c))}function _(t){F(t||"assets.json")}export{_ as pack};
